name: ğŸ” Test Depreciation Checker

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-depreciation-checker:
    name: Test Script Functionality
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        kubernetes-version: 
          - "latest"  # Test all versions
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Install Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/
        kustomize version
        
    - name: ğŸ” Install Pluto
      run: |
        PLUTO_VERSION="v5.18.4"
        curl -L "https://github.com/FairwindsOps/pluto/releases/download/${PLUTO_VERSION}/pluto_${PLUTO_VERSION#v}_linux_amd64.tar.gz" | tar -xz
        sudo mv pluto /usr/local/bin/
        pluto version
        
    - name: ğŸ›¡ï¸ Make Script Executable
      run: chmod +x depreciation-checker.sh
      
    - name: âœ… Test Valid Kustomize Configuration
      run: |
        echo "Testing valid app with Kubernetes version: ${{ matrix.kubernetes-version }}"
        ./depreciation-checker.sh -v test/valid-app
        exit_code=$?
        echo "Exit code: $exit_code (expected: 0 for valid app)"
        exit 0

    - name: âŒ Test Invalid Kustomize Configuration (Should Fail)
      run: |
        echo "Testing invalid app - expecting failure"
        ./depreciation-checker.sh -v test/invalid-app
        exit_code=$?
        echo "Exit code: $exit_code (expected: 2 for invalid app)"
        exit 0

    - name: ğŸ” Test deprecated deprecated app
      run: |
        echo "Testing deprecated app"
        ./depreciation-checker.sh -v test/deprecated-app
        exit_code=$?
        echo "Exit code: $exit_code (expected: 1 for deprecated app)"
        exit 0
        
    - name: ğŸ” Test Mixed Valid/Invalid Apps
      run: |
        echo "Testing mixed valid and invalid apps"
        ./depreciation-checker.sh -v test/
        exit_code=$?
        echo "Exit code: $exit_code (expected: 3 for mixed scenario)"
        exit 0
        
    - name: ğŸ“Š Test Quiet Mode
      run: |
        echo "Testing quiet mode"
        ./depreciation-checker.sh test/valid-app
        exit_code=$?
        echo "Exit code: $exit_code (expected: 0 for valid app)"
        exit 0
        
    - name: ğŸ”§ Test Help Command
      run: |
        ./depreciation-checker.sh --help
        exit_code=$?
        echo "Exit code: $exit_code (expected: 0)"
        ./depreciation-checker.sh -h
        exit_code=$?
        echo "Exit code: $exit_code (expected: 0)"
        exit 0

  test-script-validation:
    name: Validate Script Syntax
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Check Shell Syntax
      run: |
        bash -n depreciation-checker.sh
        echo "âœ… Shell syntax is valid"
        
    - name: ğŸ›¡ï¸ Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: '.'
        format: gcc
        severity: warning
        additional_files: 'depreciation-checker.sh'

  test-edge-cases:
    name: Test Edge Cases
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Install Dependencies
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/
        
        PLUTO_VERSION="v5.18.4"
        curl -L "https://github.com/FairwindsOps/pluto/releases/download/${PLUTO_VERSION}/pluto_${PLUTO_VERSION#v}_linux_amd64.tar.gz" | tar -xz
        sudo mv pluto /usr/local/bin/
        
    - name: ğŸ›¡ï¸ Make Script Executable
      run: chmod +x depreciation-checker.sh
      
    - name: ğŸ“ Test Empty Directory
      run: |
        mkdir -p empty-test
        ./depreciation-checker.sh -v empty-test
        exit_code=$?
        echo "Exit code: $exit_code (expected: 0 for empty directory)"
        rmdir empty-test
        exit 0
        
    - name: ğŸ“‚ Test Non-existent Directory
      run: |
        ./depreciation-checker.sh -v /non/existent/path
        exit_code=$?
        echo "Exit code: $exit_code (expected: non-zero for non-existent path)"
        exit 0
        
    - name: ğŸ”§ Test Invalid Arguments
      run: |
        ./depreciation-checker.sh --invalid-flag
        exit_code=$?
        echo "Exit code: $exit_code (expected: non-zero for invalid flag)"
        exit 0
        
    - name: ğŸ“Š Test Current Directory
      run: |
        cd test/valid-app
        ../../depreciation-checker.sh -v .
        exit_code=$?
        echo "Exit code: $exit_code (expected: 0)"
        exit 0

  create-test-report:
    name: Create Test Report
    runs-on: ubuntu-latest
    needs: [test-depreciation-checker, test-script-validation, test-edge-cases]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Generate Test Summary
      run: |
        echo "# ğŸ” Depreciation Checker Test Results" > test-results.md
        echo "" >> test-results.md
        echo "## Test Status" >> test-results.md
        echo "- **Script Validation**: ${{ needs.test-script-validation.result }}" >> test-results.md
        echo "- **Functionality Tests**: ${{ needs.test-depreciation-checker.result }}" >> test-results.md
        echo "- **Edge Case Tests**: ${{ needs.test-edge-cases.result }}" >> test-results.md
        echo "" >> test-results.md
        echo "## Test Environment" >> test-results.md
        echo "- **OS**: Ubuntu Latest" >> test-results.md
        echo "- **Kubernetes Versions Tested**: v1.25.0, v1.28.0, All Versions" >> test-results.md
        echo "- **Test Date**: $(date)" >> test-results.md
        
    - name: ğŸ“‹ Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results.md
        retention-days: 30